---
title: "Modelling approaches for meta-analyses with dependent effect sizes in ecology and evolution: A simulation study"
author: "Coralie Williams"
date: "Last compiled on `r format(Sys.time(), '%d %B, %Y')`"
format:
  html:
    page-layout: full
    toc: true
    toc-location: left
    toc-depth: 2
    theme: materia
    embed-resources: true
    code-fold: true
    code-tools: true
    number-sections: false
editor_options: 
  chunk_output_type: console
---

# Overview

This page is a summary of the results from a simulation study comparing different modelling approaches for meta-analyses with dependent effect sizes in ecology and evolution.


```{r}
#| include: false
#| echo: false

library(pacman)
p_load(tidyverse, metafor, simstudy, ggplot2, ggpubr,
       dplyr, broom, knitr, kableExtra, here, cowplot,
       ggdist, gridExtra)
```





<!--# ################# STUDY 1 ####################### -->

# Study 1

```{r}
# load data
load("~/Projects/sim-meta-eco-evo/output/study1/all_results_study1.RDATA")
results <- combined_dat


# create new variables for model type based on rhot.hat and CR method
results <- results |>
  mutate(
    model_type = case_when(
    str_detect(model, "FE") ~ "FE",
    str_detect(model, "RE") ~ "RE",
    str_detect(model, "ML-VCV") & rho.hat==0.2 ~ "ML-VCV-0.2",
    str_detect(model, "ML-VCV") & rho.hat==0.5 ~ "ML-VCV-0.5",
    str_detect(model, "ML-VCV") & rho.hat==0.8 ~ "ML-VCV-0.8",
    str_detect(model, "ML") ~ "ML"),
    CR = case_when(
      str_detect(model, "-CR0") ~ "CR0",
      str_detect(model, "-CR1") ~ "CR1",
      str_detect(model, "-CR2") ~ "CR2",
      TRUE ~ "none"))


#### IMPORTANT: reduce dataset 
#### rho.hat values are for ML-VCV models only
# separate 


## check: table(results$rho.hat, results$rho)

# filter out 
#results |> filter(CR == "none", model_type =="ML", rho == 0.2,
#                  sigma2.s == 0.05, sigma2.u == 0.05, k.studies == 20) 


# reorder factor levels for model_type and model
results$model_type <- factor(results$model_type, levels=c("FE", "RE", "ML", "ML-VCV-0.2", 
                                                          "ML-VCV-0.5", "ML-VCV-0.8"))

results$model <- factor(results$model, levels=c("FE", "RE", "ML", "ML-VCV",
                                                "FE-CR0", "RE-CR0", "ML-CR0", "ML-VCV-CR0",
                                                "FE-CR1", "RE-CR1", "ML-CR1", "ML-VCV-CR1",
                                                "FE-CR2", "RE-CR2", "ML-CR2", "ML-VCV-CR2"))

results$CR_method <- factor(results$CR_method, levels=c("none", "CR0", "CR1", "CR2"))

# derive confidence interval width
results <- results |>
  group_by(model, scenario) |>
  mutate(mu_ci_width = mu_ci_ub - mu_ci_lb)

# derive bias for mu estimate
results <- results |>
  group_by(model, scenario) |>
  mutate(mu_bias = mu_est - mu)

# derive coverage
cov_all <- results |>
  group_by(model, model_type, CR_method) |>
  summarise(cov_prop = mean(mu_cov, na.rm = TRUE))

```


```{r}
# set up colors for Study 1
model_colors <- rep(c("#7297C7", "#FECA91", "#A5D9A5", "#F4756B", "#775f95", "#dc82cf"), 6)

# remove CR2 for main analysis 
res <- results |>
  filter(CR_method != "CR2")
```


## 1. Overall mean estimate

### $\rho$ = 0.2

```{r}
r0.2 <- res |>
   filter(rho == 0.2)
```

::: panel-tabset
## Bias

Median study (k=20)

```{r}
#| fig-width: 11
#| fig-height: 7

r0.2 |> 
  filter(k.studies == 20) |> 
  ggplot(aes(x=factor(model_type), y=mu_bias, color=model_type, fill=model_type)) + 
  stat_halfeye() +
  scale_color_manual(values=model_colors)+
  scale_fill_manual(values=alpha(model_colors, 0.4)) +
  labs(title="μ estimate bias",x="", y = "μ estimate bias")+
  geom_boxplot(width=0.4)+
  facet_wrap(~ factor(CR_method))+
  geom_hline(yintercept=0, colour="darkgray")+ # mu=0.2
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```


Large study (k=50)

```{r}
#| fig-width: 11
#| fig-height: 7
 
r0.2 |> 
  filter(k.studies == 50) |> 
  ggplot(aes(x=factor(model_type), y=mu_bias, color=model_type, fill=model_type)) + 
  stat_halfeye() +
  scale_color_manual(values=model_colors)+
  scale_fill_manual(values=alpha(model_colors, 0.4)) +
  labs(title="μ estimate bias",x="", y = "μ estimate bias")+
  geom_boxplot(width=0.4)+
  facet_wrap(~ factor(CR_method))+
  geom_hline(yintercept=0, colour="darkgray")+ # mu=0.2
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```



## Mean Squared Error (MSE)

Median study (k=20)

```{r}
#| fig-width: 11
#| fig-height: 7
 
r0.2 |> 
  filter(k.studies == 20) |> 
  ggplot(aes(x=factor(model_type), y=mu_mse, color=model_type, fill=model_type)) + 
  stat_halfeye() +
  scale_color_manual(values=model_colors)+
  scale_fill_manual(values=alpha(model_colors, 0.4)) +
  labs(title="μ estimate MSE",x="", y = "MSE")+
  geom_boxplot(width=0.4)+
  facet_wrap(~ factor(CR_method))+
  geom_hline(yintercept=0, colour="darkgray")+ # mu=0.2
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```


Large study (k=50)

```{r}
#| fig-width: 11
#| fig-height: 7

r0.2 |> 
  filter(k.studies == 50) |> 
  ggplot(aes(x=factor(model_type), y=mu_mse, color=model_type, fill=model_type)) + 
  stat_halfeye() +
  scale_color_manual(values=model_colors)+
  scale_fill_manual(values=alpha(model_colors, 0.4)) +
  labs(title="μ estimate MSE",x="", y = "MSE")+
  geom_boxplot(width=0.4)+
  facet_wrap(~ factor(CR_method))+
  geom_hline(yintercept=0, colour="darkgray")+ # mu=0.2
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```




## Coverage

```{r}
#| echo: FALSE

# Derive coverage proportion per model
cov_0.2 <- r0.2 %>%
  group_by(model_type, CR_method, k.studies) %>%
  summarise(cov_prop = mean(mu_cov, na.rm = TRUE))
```


Median study (k=20)
```{r}
#| fig-width: 11
#| fig-height: 7

cov_0.2 |> 
  filter(k.studies == 20) |> 
  ggplot(aes(x=model_type, y=cov_prop, color=CR_method, fill=CR_method)) +
    geom_bar(stat="identity", position=position_dodge(width=0.9), alpha=0.6) +
    scale_color_manual(values=model_colors) +
    scale_fill_manual(values=model_colors, 0.4) +
    scale_y_continuous(breaks=seq(0,1,0.1), limits=c(0, 1)) +
    labs(title="Coverage proportion of μ estimate (over 5000 replications)",
        x="Model",
        y="Coverage proportion") +
    theme_bw()

```

Large study (k=50)
```{r}
#| fig-width: 11
#| fig-height: 7

cov_0.2 |> 
  filter(k.studies == 50) |> 
  ggplot(aes(x=model_type, y=cov_prop, color=CR_method, fill=CR_method)) +
    geom_bar(stat="identity", position=position_dodge(width=0.9), alpha=0.6) +
    scale_color_manual(values=model_colors) +
    scale_fill_manual(values=model_colors, 0.4) +
    scale_y_continuous(breaks=seq(0,1,0.1), limits=c(0, 1)) +
    labs(title="Coverage proportion of μ estimate (over 5000 replications)",
        x="Model",
        y="Coverage proportion") +
    theme_bw()

```


## Confidence interval width

Median study (k=20)

```{r}
#| fig-width: 11
#| fig-height: 7

r0.2 |> 
  filter(k.studies == 20) |> 
  ggplot(aes(x=factor(model_type), y=mu_ci_width, color=model_type, fill=model_type)) + 
  stat_halfeye() +
  scale_color_manual(values=model_colors)+
  scale_fill_manual(values=alpha(model_colors, 0.4)) +
  labs(title="μ estimate confidence interval width", x="", y = "CI width")+
  geom_boxplot(width=0.4)+
  facet_wrap(~ factor(CR_method))+
  geom_hline(yintercept=0, colour="darkgray")+ # mu=0.2
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```


Large study (k=50)

```{r}
#| fig-width: 11
#| fig-height: 7

r0.2 |> 
  filter(k.studies == 50) |> 
  ggplot(aes(x=factor(model_type), y=mu_ci_width, color=model_type, fill=model_type)) + 
  stat_halfeye() +
  scale_color_manual(values=model_colors)+
  scale_fill_manual(values=alpha(model_colors, 0.4)) +
  labs(title="μ estimate confidence interval width", x="", y = "CI width")+
  geom_boxplot(width=0.4)+
  facet_wrap(~ factor(CR_method))+
  geom_hline(yintercept=0, colour="darkgray")+ # mu=0.2
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```



:::



```{r}
#| include = FALSE
r0.2 |> 
  filter(k.studies == 50) |> 
  group_by(model_type, CR_method, rho.hat) |>
  summarise(mean_mu_bias = signif(mean(mu_est - mu), 3), 
            mean_mu_mse = signif(mean(mu_mse), 3), 
            mean_ci_width = signif(mean(mu_ci_width), 3), 
            mean_coverage = signif(mean(mu_cov), 3)) |>
  knitr::kable()

```


## 2. Effect size level (residual) variance estimate



## 3. Study level variance estimate


## Supplementary: CRVE variants

::: panel-tabset

:::




<!--# ################# STUDY 1 ####################### -->

# Study 2


```{r}
load("~/Projects/sim-meta-eco-evo/output/study2/all_results_study2.RDATA")
results <- combined_dat


```

