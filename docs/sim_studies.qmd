---
title: "Modelling approaches for meta-analyses with dependent effect sizes in ecology and evolution: A simulation study"
author: "Coralie Williams"
date: "Last compiled on `r format(Sys.time(), '%d %B, %Y')`"
format:
  html:
    page-layout: full
    toc: true
    toc-location: left
    toc-depth: 2
    theme: materia
    embed-resources: true
    code-fold: true
    code-tools: true
    number-sections: false
editor_options: 
  chunk_output_type: console
---

# Overview

This page is a summary of the results from a simulation study comparing different modelling approaches for meta-analyses with dependent effect sizes in ecology and evolution.

```{r}
#| include: false
#| echo: false

library(pacman)
p_load(patchWork)
```

<!--# ################# STUDY 1 ####################### -->

# Study 1

```{r}
# load plots


```



```{r}
# Make plot for main text
Figure_ReportingPractices <- supp1 / supp2 +
  plot_annotation(tag_levels = 'A')
```

## 1. Overall mean estimate

### $\rho$ = 0.2

Across all 4 conditions of $\sigma^2_u$ and $\sigma^2_s$.

```{r}
r0.2 <- res |>
   filter(rho == 0.2)
```

::: panel-tabset
## Bias

Standard study (k=20)

```{r}
#| fig-width: 11
#| fig-height: 7

r0.2 |> 
  filter(k.studies == 20) |> 
  ggplot(aes(x=factor(model_type), y=mu_bias, color=model_type, fill=model_type)) + 
  stat_halfeye() +
  scale_color_manual(values=model_colors)+
  scale_fill_manual(values=alpha(model_colors, 0.4)) +
  labs(title="μ estimate bias",x="", y = "μ estimate bias")+
  geom_boxplot(width=0.4)+
  facet_wrap(~ factor(CR_method))+
  geom_hline(yintercept=0, colour="darkgray")+ # mu=0.2
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

Large study (k=50)

```{r}
#| fig-width: 11
#| fig-height: 7
 
r0.2 |> 
  filter(k.studies == 50) |> 
  ggplot(aes(x=factor(model_type), y=mu_bias, color=model_type, fill=model_type)) + 
  stat_halfeye() +
  scale_color_manual(values=model_colors)+
  scale_fill_manual(values=alpha(model_colors, 0.4)) +
  labs(title="μ estimate bias",x="", y = "μ estimate bias")+
  geom_boxplot(width=0.4)+
  facet_wrap(~ factor(CR_method))+
  geom_hline(yintercept=0, colour="darkgray")+ # mu=0.2
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

## Mean Squared Error (MSE)

Standard study (k=20)

```{r}
#| fig-width: 11
#| fig-height: 7
 
r0.2 |> 
  filter(k.studies == 20) |> 
  ggplot(aes(x=factor(model_type), y=mu_mse, color=model_type, fill=model_type)) + 
  stat_halfeye() +
  scale_color_manual(values=model_colors)+
  scale_fill_manual(values=alpha(model_colors, 0.4)) +
  labs(title="μ estimate MSE",x="", y = "MSE")+
  geom_boxplot(width=0.4)+
  facet_wrap(~ factor(CR_method))+
  geom_hline(yintercept=0, colour="darkgray")+ # mu=0.2
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

Large study (k=50)

```{r}
#| fig-width: 11
#| fig-height: 7

r0.2 |> 
  filter(k.studies == 50) |> 
  ggplot(aes(x=factor(model_type), y=mu_mse, color=model_type, fill=model_type)) + 
  stat_halfeye() +
  scale_color_manual(values=model_colors)+
  scale_fill_manual(values=alpha(model_colors, 0.4)) +
  labs(title="μ estimate MSE",x="", y = "MSE")+
  geom_boxplot(width=0.4)+
  facet_wrap(~ factor(CR_method))+
  geom_hline(yintercept=0, colour="darkgray")+ # mu=0.2
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

## Coverage

```{r}
#| echo: FALSE

# Derive coverage proportion per model
cov_0.2 <- r0.2 %>%
  group_by(model_type, CR_method, k.studies) %>%
  summarise(cov_prop = mean(mu_cov, na.rm = TRUE))
```

Standard study (k=20)

```{r}
#| fig-width: 11
#| fig-height: 7

cov_0.2 |> 
  filter(k.studies == 20) |> 
  ggplot(aes(x=model_type, y=cov_prop, color=CR_method, fill=CR_method)) +
    geom_bar(stat="identity", position=position_dodge(width=0.9), alpha=0.6) +
    scale_color_manual(values=model_colors) +
    scale_fill_manual(values=model_colors, 0.4) +
    scale_y_continuous(breaks=seq(0,1,0.1), limits=c(0, 1)) +
    labs(title="Coverage proportion of μ estimate (over 5000 replications)",
        x="Model",
        y="Coverage proportion") +
    theme_bw()

```

Large study (k=50)

```{r}
#| fig-width: 11
#| fig-height: 7

cov_0.2 |> 
  filter(k.studies == 50) |> 
  ggplot(aes(x=model_type, y=cov_prop, color=CR_method, fill=CR_method)) +
    geom_bar(stat="identity", position=position_dodge(width=0.9), alpha=0.6) +
    scale_color_manual(values=model_colors) +
    scale_fill_manual(values=model_colors, 0.4) +
    scale_y_continuous(breaks=seq(0,1,0.1), limits=c(0, 1)) +
    labs(title="Coverage proportion of μ estimate (over 5000 replications)",
        x="Model",
        y="Coverage proportion") +
    theme_bw()

```

## Confidence interval width

Standard study (k=20)

```{r}
#| fig-width: 11
#| fig-height: 7

r0.2 |> 
  filter(k.studies == 20) |> 
  ggplot(aes(x=factor(model_type), y=mu_ci_width, color=model_type, fill=model_type)) + 
  stat_halfeye() +
  scale_color_manual(values=model_colors)+
  scale_fill_manual(values=alpha(model_colors, 0.4)) +
  labs(title="μ estimate confidence interval width", x="", y = "CI width")+
  geom_boxplot(width=0.4)+
  facet_wrap(~ factor(CR_method))+
  geom_hline(yintercept=0, colour="darkgray")+ # mu=0.2
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

Large study (k=50)

```{r}
#| fig-width: 11
#| fig-height: 7

r0.2 |> 
  filter(k.studies == 50) |> 
  ggplot(aes(x=factor(model_type), y=mu_ci_width, color=model_type, fill=model_type)) + 
  stat_halfeye() +
  scale_color_manual(values=model_colors)+
  scale_fill_manual(values=alpha(model_colors, 0.4)) +
  labs(title="μ estimate confidence interval width", x="", y = "CI width")+
  geom_boxplot(width=0.4)+
  facet_wrap(~ factor(CR_method))+
  geom_hline(yintercept=0, colour="darkgray")+ # mu=0.2
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```
:::

```{r}
#| include = FALSE
r0.2 |> 
  filter(k.studies == 50) |> 
  group_by(model_type, CR_method, rho.hat) |>
  summarise(mean_mu_bias = signif(mean(mu_est - mu), 3), 
            mean_mu_mse = signif(mean(mu_mse), 3), 
            mean_ci_width = signif(mean(mu_ci_width), 3), 
            mean_coverage = signif(mean(mu_cov), 3)) |>
  knitr::kable()

```

### $\rho$ = 0.5

```{r}
r0.5 <- res |>
   filter(rho == 0.5)
```

::: panel-tabset
## Bias

Standard study (k=20)

```{r}
#| fig-width: 11
#| fig-height: 7

r0.5 |> 
  filter(k.studies == 20) |> 
  ggplot(aes(x=factor(model_type), y=mu_bias, color=model_type, fill=model_type)) + 
  stat_halfeye() +
  scale_color_manual(values=model_colors)+
  scale_fill_manual(values=alpha(model_colors, 0.4)) +
  labs(title="μ estimate bias",x="", y = "μ estimate bias")+
  geom_boxplot(width=0.4)+
  facet_wrap(~ factor(CR_method))+
  geom_hline(yintercept=0, colour="darkgray")+ # mu=0.2
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

Large study (k=50)

```{r}
#| fig-width: 11
#| fig-height: 7
 
r0.5 |> 
  filter(k.studies == 50) |> 
  ggplot(aes(x=factor(model_type), y=mu_bias, color=model_type, fill=model_type)) + 
  stat_halfeye() +
  scale_color_manual(values=model_colors)+
  scale_fill_manual(values=alpha(model_colors, 0.4)) +
  labs(title="μ estimate bias",x="", y = "μ estimate bias")+
  geom_boxplot(width=0.4)+
  facet_wrap(~ factor(CR_method))+
  geom_hline(yintercept=0, colour="darkgray")+ # mu=0.2
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

## Mean Squared Error (MSE)

Standard study (k=20)

```{r}
#| fig-width: 11
#| fig-height: 7
 
r0.5 |> 
  filter(k.studies == 20) |> 
  ggplot(aes(x=factor(model_type), y=mu_mse, color=model_type, fill=model_type)) + 
  stat_halfeye() +
  scale_color_manual(values=model_colors)+
  scale_fill_manual(values=alpha(model_colors, 0.4)) +
  labs(title="μ estimate MSE",x="", y = "MSE")+
  geom_boxplot(width=0.4)+
  facet_wrap(~ factor(CR_method))+
  geom_hline(yintercept=0, colour="darkgray")+ # mu=0.2
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

Large study (k=50)

```{r}
#| fig-width: 11
#| fig-height: 7

r0.5 |> 
  filter(k.studies == 50) |> 
  ggplot(aes(x=factor(model_type), y=mu_mse, color=model_type, fill=model_type)) + 
  stat_halfeye() +
  scale_color_manual(values=model_colors)+
  scale_fill_manual(values=alpha(model_colors, 0.4)) +
  labs(title="μ estimate MSE",x="", y = "MSE")+
  geom_boxplot(width=0.4)+
  facet_wrap(~ factor(CR_method))+
  geom_hline(yintercept=0, colour="darkgray")+ # mu=0.2
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

## Coverage

```{r}
#| echo: FALSE

# Derive coverage proportion per model
cov_0.2 <- r0.5 %>%
  group_by(model_type, CR_method, k.studies) %>%
  summarise(cov_prop = mean(mu_cov, na.rm = TRUE))
```

Standard study (k=20)

```{r}
#| fig-width: 11
#| fig-height: 7

cov_0.2 |> 
  filter(k.studies == 20) |> 
  ggplot(aes(x=model_type, y=cov_prop, color=CR_method, fill=CR_method)) +
    geom_bar(stat="identity", position=position_dodge(width=0.9), alpha=0.6) +
    scale_color_manual(values=model_colors) +
    scale_fill_manual(values=model_colors, 0.4) +
    scale_y_continuous(breaks=seq(0,1,0.1), limits=c(0, 1)) +
    labs(title="Coverage proportion of μ estimate (over 5000 replications)",
        x="Model",
        y="Coverage proportion") +
    theme_bw()

```

Large study (k=50)

```{r}
#| fig-width: 11
#| fig-height: 7

cov_0.2 |> 
  filter(k.studies == 50) |> 
  ggplot(aes(x=model_type, y=cov_prop, color=CR_method, fill=CR_method)) +
    geom_bar(stat="identity", position=position_dodge(width=0.9), alpha=0.6) +
    scale_color_manual(values=model_colors) +
    scale_fill_manual(values=model_colors, 0.4) +
    scale_y_continuous(breaks=seq(0,1,0.1), limits=c(0, 1)) +
    labs(title="Coverage proportion of μ estimate (over 5000 replications)",
        x="Model",
        y="Coverage proportion") +
    theme_bw()

```

## Confidence interval width

Standard study (k=20)

```{r}
#| fig-width: 11
#| fig-height: 7

r0.5 |> 
  filter(k.studies == 20) |> 
  ggplot(aes(x=factor(model_type), y=mu_ci_width, color=model_type, fill=model_type)) + 
  stat_halfeye() +
  scale_color_manual(values=model_colors)+
  scale_fill_manual(values=alpha(model_colors, 0.4)) +
  labs(title="μ estimate confidence interval width", x="", y = "CI width")+
  geom_boxplot(width=0.4)+
  facet_wrap(~ factor(CR_method))+
  geom_hline(yintercept=0, colour="darkgray")+ # mu=0.2
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

Large study (k=50)

```{r}
#| fig-width: 11
#| fig-height: 7

r0.5 |> 
  filter(k.studies == 50) |> 
  ggplot(aes(x=factor(model_type), y=mu_ci_width, color=model_type, fill=model_type)) + 
  stat_halfeye() +
  scale_color_manual(values=model_colors)+
  scale_fill_manual(values=alpha(model_colors, 0.4)) +
  labs(title="μ estimate confidence interval width", x="", y = "CI width")+
  geom_boxplot(width=0.4)+
  facet_wrap(~ factor(CR_method))+
  geom_hline(yintercept=0, colour="darkgray")+ # mu=0.2
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```
:::

### $\rho$ = 0.8

```{r}
r0.8 <- res |>
   filter(rho == 0.8)
```

::: panel-tabset
## Bias

Standard study (k=20)

```{r}
#| fig-width: 11
#| fig-height: 7

r0.5 |> 
  filter(k.studies == 20) |> 
  ggplot(aes(x=factor(model_type), y=mu_bias, color=model_type, fill=model_type)) + 
  stat_halfeye() +
  scale_color_manual(values=model_colors)+
  scale_fill_manual(values=alpha(model_colors, 0.4)) +
  labs(title="μ estimate bias",x="", y = "μ estimate bias")+
  geom_boxplot(width=0.4)+
  facet_wrap(~ factor(CR_method))+
  geom_hline(yintercept=0, colour="darkgray")+ # mu=0.2
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

Large study (k=50)

```{r}
#| fig-width: 11
#| fig-height: 7
 
r0.5 |> 
  filter(k.studies == 50) |> 
  ggplot(aes(x=factor(model_type), y=mu_bias, color=model_type, fill=model_type)) + 
  stat_halfeye() +
  scale_color_manual(values=model_colors)+
  scale_fill_manual(values=alpha(model_colors, 0.4)) +
  labs(title="μ estimate bias",x="", y = "μ estimate bias")+
  geom_boxplot(width=0.4)+
  facet_wrap(~ factor(CR_method))+
  geom_hline(yintercept=0, colour="darkgray")+ # mu=0.2
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

## Mean Squared Error (MSE)

Standard study (k=20)

```{r}
#| fig-width: 11
#| fig-height: 7
 
r0.5 |> 
  filter(k.studies == 20) |> 
  ggplot(aes(x=factor(model_type), y=mu_mse, color=model_type, fill=model_type)) + 
  stat_halfeye() +
  scale_color_manual(values=model_colors)+
  scale_fill_manual(values=alpha(model_colors, 0.4)) +
  labs(title="μ estimate MSE",x="", y = "MSE")+
  geom_boxplot(width=0.4)+
  facet_wrap(~ factor(CR_method))+
  geom_hline(yintercept=0, colour="darkgray")+ # mu=0.2
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

Large study (k=50)

```{r}
#| fig-width: 11
#| fig-height: 7

r0.5 |> 
  filter(k.studies == 50) |> 
  ggplot(aes(x=factor(model_type), y=mu_mse, color=model_type, fill=model_type)) + 
  stat_halfeye() +
  scale_color_manual(values=model_colors)+
  scale_fill_manual(values=alpha(model_colors, 0.4)) +
  labs(title="μ estimate MSE",x="", y = "MSE")+
  geom_boxplot(width=0.4)+
  facet_wrap(~ factor(CR_method))+
  geom_hline(yintercept=0, colour="darkgray")+ # mu=0.2
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

## Coverage

```{r}
#| echo: FALSE

# Derive coverage proportion per model
cov_0.2 <- r0.5 %>%
  group_by(model_type, CR_method, k.studies) %>%
  summarise(cov_prop = mean(mu_cov, na.rm = TRUE))
```

Standard study (k=20)

```{r}
#| fig-width: 11
#| fig-height: 7

cov_0.2 |> 
  filter(k.studies == 20) |> 
  ggplot(aes(x=model_type, y=cov_prop, color=CR_method, fill=CR_method)) +
    geom_bar(stat="identity", position=position_dodge(width=0.9), alpha=0.6) +
    scale_color_manual(values=model_colors) +
    scale_fill_manual(values=model_colors, 0.4) +
    scale_y_continuous(breaks=seq(0,1,0.1), limits=c(0, 1)) +
    labs(title="Coverage proportion of μ estimate (over 5000 replications)",
        x="Model",
        y="Coverage proportion") +
    theme_bw()

```

Large study (k=50)

```{r}
#| fig-width: 11
#| fig-height: 7

cov_0.2 |> 
  filter(k.studies == 50) |> 
  ggplot(aes(x=model_type, y=cov_prop, color=CR_method, fill=CR_method)) +
    geom_bar(stat="identity", position=position_dodge(width=0.9), alpha=0.6) +
    scale_color_manual(values=model_colors) +
    scale_fill_manual(values=model_colors, 0.4) +
    scale_y_continuous(breaks=seq(0,1,0.1), limits=c(0, 1)) +
    labs(title="Coverage proportion of μ estimate (over 5000 replications)",
        x="Model",
        y="Coverage proportion") +
    theme_bw()

```

## Confidence interval width

Standard study (k=20)

```{r}
#| fig-width: 11
#| fig-height: 7

r0.5 |> 
  filter(k.studies == 20) |> 
  ggplot(aes(x=factor(model_type), y=mu_ci_width, color=model_type, fill=model_type)) + 
  stat_halfeye() +
  scale_color_manual(values=model_colors)+
  scale_fill_manual(values=alpha(model_colors, 0.4)) +
  labs(title="μ estimate confidence interval width", x="", y = "CI width")+
  geom_boxplot(width=0.4)+
  facet_wrap(~ factor(CR_method))+
  geom_hline(yintercept=0, colour="darkgray")+ # mu=0.2
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

Large study (k=50)

```{r}
#| fig-width: 11
#| fig-height: 7

r0.5 |> 
  filter(k.studies == 50) |> 
  ggplot(aes(x=factor(model_type), y=mu_ci_width, color=model_type, fill=model_type)) + 
  stat_halfeye() +
  scale_color_manual(values=model_colors)+
  scale_fill_manual(values=alpha(model_colors, 0.4)) +
  labs(title="μ estimate confidence interval width", x="", y = "CI width")+
  geom_boxplot(width=0.4)+
  facet_wrap(~ factor(CR_method))+
  geom_hline(yintercept=0, colour="darkgray")+ # mu=0.2
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```
:::

## 2. Effect size level (residual) variance estimate

## 3. Study level variance estimate

## Supplementary: CRVE variants

::: panel-tabset
:::

<!--# ################# STUDY 1 ####################### -->

# Study 2

```{r}
load("~/Projects/sim-meta-eco-evo/output/study2/all_results_study2.RDATA")
results <- combined_dat


```
